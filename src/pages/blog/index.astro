---
// astro components
import BaseLayout from "@/layouts/BaseLayout.astro";
// astro db
import { db, Views } from "astro:db";
// react components
import FilterAndPostSection from "@/components/Blog/FilterAndPostSection";
// content collection
import { getCollection } from "astro:content";

const posts = await getCollection(
  "posts",
  (post) => post.data.isDraft === false
);
// 將非同步post.render()的結果取出minutes
const fetchPostDetails = async () => {
  const details = await Promise.all(
    posts.map(async (post) => {
      const renderedPost = await post.render();
      return {
        ...post,
        minutes: renderedPost.remarkPluginFrontmatter.minutes,
      };
    })
  );
  return details;
};

type FoundView = {
  slug: string;
  count: number;
};
const foundViews: FoundView[] = await db.select().from(Views);
type SlugToViewsMap = {
  [slug: string]: number;
};
const slugToViewsMap: SlugToViewsMap = foundViews.reduce(
  (acc: SlugToViewsMap, { slug, count }) => {
    acc[slug] = count;
    return acc;
  },
  {}
);

const augmentedAllPosts = await fetchPostDetails();
export const prerender = false;
---

<BaseLayout pageTitle="Blog"
  ><FilterAndPostSection
    allPosts={augmentedAllPosts}
    slugToViewsMap={slugToViewsMap}
    client:only="react"
  />
</BaseLayout>
